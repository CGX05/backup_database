name: backup_database

on: 
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ä¸‹è½½ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      run: |
        echo "åˆ›å»º.envé…ç½®æ–‡ä»¶"
        echo "MYSQL_HOST=localhost" > .env
        echo "MYSQL_PORT=3306" >> .env
        echo "MYSQL_USER=root" >> .env
        echo "MYSQL_PASSWORD=${{secrets.DATABASE_PASSWORD}}" >> .env
        echo "BACKUP_DIR=./backups" >> .env
        # æ˜¾ç¤ºé…ç½®ï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
        cat .env | grep -v PASSWORD

    - name: å®‰è£…ä¾èµ–
      run: pip install -r requirements.txt

    - name: å®‰è£…sshpass
      run: sudo apt-get install -y sshpass

    - name: æµ‹è¯•æœåŠ¡å™¨è¿æ¥
      run: |
        echo "æµ‹è¯•è¿æ¥åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          echo 'âœ… æˆåŠŸè¿æ¥åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼'
          echo 'ğŸ–¥ï¸  æœåŠ¡å™¨ä¿¡æ¯ï¼š'
          uname -a
          echo 'ğŸ“ å½“å‰ç›®å½•ï¼š'
          pwd
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: åœ¨æœåŠ¡å™¨åˆ›å»ºåº”ç”¨ç›®å½•
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          # åˆ›å»ºåº”ç”¨ç›®å½•ï¼ˆä¿®æ­£è·¯å¾„ï¼‰
          mkdir -p /home/mysql-backup-api
          echo 'ğŸ“ åº”ç”¨ç›®å½•åˆ›å»ºå®Œæˆï¼š/home/mysql-backup-api'
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
      run: |
        echo "å¼€å§‹ä¸Šä¼ ä»£ç åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        scp -o StrictHostKeyChecking=no \
            -r ./* \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/mysql-backup-api/
        echo 'âœ… ä»£ç ä¸Šä¼ å®Œæˆï¼'
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd /home/mysql-backup-api
          echo 'ğŸ å®‰è£…Pythonä¾èµ–...'
          pip3 install -r requirements.txt
          echo 'âœ… ä¾èµ–å®‰è£…å®Œæˆï¼'
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: åœ¨åº”ç”¨ç›®å½•æ‰§è¡ŒMySQLå¤‡ä»½
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd /home/mysql-backup-api  # ä¿®æ­£è·¯å¾„ï¼š/home ä¸æ˜¯ /hoem
          echo 'ğŸ—„ï¸  å¼€å§‹MySQLå¤‡ä»½...'
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          mkdir -p backups
          # æ‰§è¡Œå¤‡ä»½ï¼ˆç¡®ä¿æ•°æ®åº“åæ­£ç¡®ï¼‰
          mysqldump -h localhost -u root -p'${{ secrets.DATABASE_PASSWORD }}' your_database > backups/backup_$(date +%Y%m%d_%H%M%S).sql
          echo 'âœ… MySQLå¤‡ä»½å®Œæˆï¼'
          echo 'ğŸ“Š å¤‡ä»½æ–‡ä»¶åˆ—è¡¨ï¼š'
          ls -la backups/
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: å¯åŠ¨åº”ç”¨å¹¶ä¿æŒè¿è¡Œ
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd /home/mysql-backup-api
          echo 'ğŸš€ å¯åŠ¨åº”ç”¨...'
          
          # åœæ­¢å¯èƒ½å·²ç»åœ¨è¿è¡Œçš„åº”ç”¨
          pkill -f 'python3 main.py' || true
          
          # ä½¿ç”¨screenæˆ–tmuxä¿æŒè¿›ç¨‹è¿è¡Œï¼Œæˆ–è€…ä½¿ç”¨systemdæœåŠ¡
          # æ–¹æ³•1ï¼šä½¿ç”¨nohupå¹¶é‡å®šå‘ï¼ˆæ”¹è¿›ç‰ˆï¼‰
          nohup python3 main.py > app.log 2>&1 &
          
          # ç­‰å¾…ä¸€ä¸‹è®©è¿›ç¨‹å¯åŠ¨
          sleep 3
          
          echo 'âœ… åº”ç”¨å¯åŠ¨å®Œæˆï¼'
          echo 'ğŸ“‹ æŸ¥çœ‹è¿›ç¨‹ï¼š'
          ps aux | grep python | grep -v grep
          
          echo 'ğŸ“ æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š'
          tail -n 5 app.log
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: éªŒè¯åº”ç”¨è¿è¡Œ
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" \
        ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          echo 'ğŸ” éªŒè¯åº”ç”¨è¿è¡ŒçŠ¶æ€...'
          echo '1. æ£€æŸ¥è¿›ç¨‹ï¼š'
          ps aux | grep 'python3 main.py' | grep -v grep
          
          echo '2. æ£€æŸ¥ç«¯å£ï¼š'
          netstat -tlnp | grep :8000 || echo '8000ç«¯å£æœªç›‘å¬'
          
          echo '3. æµ‹è¯•æ¥å£ï¼š'
          curl -s http://localhost:8000/ || echo 'åº”ç”¨æœªå“åº”'
          
          echo '4. æŸ¥çœ‹æ—¥å¿—ï¼š'
          tail -n 10 /home/mysql-backup-api/app.log
        "
      env:
        SSHPASS: ${{ secrets.SERVER_PASSWORD }}

    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      run: |
        echo 'ğŸ‰ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨å®Œæˆï¼'
        echo 'ğŸŒ æœåŠ¡å™¨IP: ${{ secrets.SERVER_HOST }}'
        echo 'ğŸ“ åº”ç”¨è·¯å¾„: /home/mysql-backup-api/'
        echo 'ğŸ“Š æŸ¥çœ‹åº”ç”¨: http://${{ secrets.SERVER_HOST }}:8000'